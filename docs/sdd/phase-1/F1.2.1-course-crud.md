# F1.2.1: Course Collection & CRUD Operations

**Version:** 1.0.0
**Priority:** P0 (Critical)
**Effort:** Medium (3-4 days)
**Dependencies:** F1.1.1, F1.1.2, F1.1.3

---

## Overview

Implement the Course collection in Payload CMS with full CRUD operations. Courses are the core entity of Learning Hall - they contain modules, which contain lessons.

---

## Objectives

1. Create Course collection with all necessary fields
2. Implement tenant-scoped access control
3. Build course listing API
4. Build course detail API
5. Create course management UI in dashboard
6. Add course validation rules
7. Implement course status workflow (draft → published → archived)

---

## Technical Specification

### Course Collection Schema

```typescript
// src/collections/Courses.ts
import type { CollectionConfig } from 'payload';

export const Courses: CollectionConfig = {
  slug: 'courses',
  admin: {
    useAsTitle: 'title',
    defaultColumns: ['title', 'instructor', 'status', 'price', 'updatedAt'],
    group: 'Content',
  },
  access: {
    // Anyone can read published courses
    read: ({ req }) => {
      if (req.user?.role === 'admin') return true;

      // Instructors can read their own courses
      if (req.user?.role === 'instructor') {
        return {
          or: [
            { status: { equals: 'published' } },
            { instructor: { equals: req.user.id } },
          ],
        };
      }

      // Students can only see published courses
      return { status: { equals: 'published' } };
    },
    // Only instructors and admins can create
    create: ({ req }) => {
      return ['admin', 'instructor'].includes(req.user?.role || '');
    },
    // Only owner or admin can update
    update: ({ req }) => {
      if (req.user?.role === 'admin') return true;
      return { instructor: { equals: req.user?.id } };
    },
    // Only admin can delete
    delete: ({ req }) => req.user?.role === 'admin',
  },
  hooks: {
    beforeChange: [
      // Auto-generate slug from title
      async ({ data, operation }) => {
        if (operation === 'create' && data.title && !data.slug) {
          data.slug = data.title
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
        }
        return data;
      },
      // Set instructor to current user on create
      async ({ data, req, operation }) => {
        if (operation === 'create' && !data.instructor) {
          data.instructor = req.user?.id;
        }
        return data;
      },
    ],
    afterChange: [
      // Revalidate Next.js cache
      async ({ doc }) => {
        // Trigger ISR revalidation
        await fetch(`${process.env.NEXT_PUBLIC_URL}/api/revalidate?path=/courses/${doc.slug}`);
      },
    ],
  },
  fields: [
    {
      name: 'title',
      type: 'text',
      required: true,
      minLength: 3,
      maxLength: 200,
      admin: {
        description: 'The title of your course (3-200 characters)',
      },
    },
    {
      name: 'slug',
      type: 'text',
      required: true,
      unique: true,
      admin: {
        position: 'sidebar',
        description: 'URL-friendly identifier (auto-generated from title)',
      },
    },
    {
      name: 'description',
      type: 'richText',
      admin: {
        description: 'Detailed description shown on course page',
      },
    },
    {
      name: 'shortDescription',
      type: 'textarea',
      maxLength: 300,
      admin: {
        description: 'Brief description for course cards (max 300 chars)',
      },
    },
    {
      name: 'thumbnail',
      type: 'upload',
      relationTo: 'media',
      admin: {
        description: 'Course thumbnail image (16:9 ratio recommended)',
      },
    },
    {
      name: 'instructor',
      type: 'relationship',
      relationTo: 'users',
      required: true,
      hasMany: false,
      admin: {
        position: 'sidebar',
        condition: (data, siblingData, { user }) => user?.role === 'admin',
      },
    },
    {
      name: 'status',
      type: 'select',
      required: true,
      defaultValue: 'draft',
      options: [
        { label: 'Draft', value: 'draft' },
        { label: 'Published', value: 'published' },
        { label: 'Archived', value: 'archived' },
      ],
      admin: {
        position: 'sidebar',
      },
    },
    {
      name: 'price',
      type: 'group',
      fields: [
        {
          name: 'amount',
          type: 'number',
          required: true,
          defaultValue: 0,
          min: 0,
          admin: {
            description: 'Price in cents (0 = free)',
          },
        },
        {
          name: 'currency',
          type: 'select',
          required: true,
          defaultValue: 'USD',
          options: [
            { label: 'USD ($)', value: 'USD' },
            { label: 'EUR (€)', value: 'EUR' },
            { label: 'GBP (£)', value: 'GBP' },
          ],
        },
      ],
    },
    {
      name: 'modules',
      type: 'relationship',
      relationTo: 'modules',
      hasMany: true,
      admin: {
        description: 'Course modules (sections)',
      },
    },
    {
      name: 'settings',
      type: 'group',
      admin: {
        description: 'Course settings',
      },
      fields: [
        {
          name: 'allowPreview',
          type: 'checkbox',
          defaultValue: true,
          label: 'Allow preview lessons',
        },
        {
          name: 'requireSequentialProgress',
          type: 'checkbox',
          defaultValue: false,
          label: 'Require sequential lesson completion',
        },
        {
          name: 'certificateEnabled',
          type: 'checkbox',
          defaultValue: true,
          label: 'Issue certificate on completion',
        },
      ],
    },
    {
      name: 'seo',
      type: 'group',
      admin: {
        description: 'SEO settings',
      },
      fields: [
        {
          name: 'metaTitle',
          type: 'text',
          maxLength: 60,
        },
        {
          name: 'metaDescription',
          type: 'textarea',
          maxLength: 160,
        },
        {
          name: 'ogImage',
          type: 'upload',
          relationTo: 'media',
        },
      ],
    },
    {
      name: 'publishedAt',
      type: 'date',
      admin: {
        position: 'sidebar',
        date: {
          pickerAppearance: 'dayAndTime',
        },
      },
    },
  ],
  timestamps: true,
};
```

### API Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/courses` | List courses (paginated) | Optional |
| GET | `/api/courses/:slug` | Get course by slug | Optional |
| POST | `/api/courses` | Create course | Instructor+ |
| PATCH | `/api/courses/:id` | Update course | Owner/Admin |
| DELETE | `/api/courses/:id` | Delete course | Admin |

### Server Actions

```typescript
// src/app/(dashboard)/courses/actions.ts
'use server';

import { revalidatePath } from 'next/cache';
import { redirect } from 'next/navigation';
import { getPayloadClient } from '@/lib/payload';
import { auth } from '@/lib/auth';
import { courseSchema, type CourseInput } from '@/lib/validations/course';

export async function createCourse(input: CourseInput) {
  const session = await auth();
  if (!session?.user) {
    throw new Error('Unauthorized');
  }

  const payload = await getPayloadClient();
  const data = courseSchema.parse(input);

  const course = await payload.create({
    collection: 'courses',
    data: {
      ...data,
      instructor: session.user.id,
      status: 'draft',
    },
  });

  revalidatePath('/dashboard/courses');
  redirect(`/dashboard/courses/${course.id}/edit`);
}

export async function updateCourse(id: string, input: Partial<CourseInput>) {
  const session = await auth();
  if (!session?.user) {
    throw new Error('Unauthorized');
  }

  const payload = await getPayloadClient();

  const course = await payload.update({
    collection: 'courses',
    id,
    data: input,
  });

  revalidatePath('/dashboard/courses');
  revalidatePath(`/courses/${course.slug}`);

  return course;
}

export async function publishCourse(id: string) {
  const session = await auth();
  if (!session?.user) {
    throw new Error('Unauthorized');
  }

  const payload = await getPayloadClient();

  const course = await payload.update({
    collection: 'courses',
    id,
    data: {
      status: 'published',
      publishedAt: new Date().toISOString(),
    },
  });

  revalidatePath('/dashboard/courses');
  revalidatePath(`/courses/${course.slug}`);
  revalidatePath('/courses');

  return course;
}

export async function deleteCourse(id: string) {
  const session = await auth();
  if (!session?.user || session.user.role !== 'admin') {
    throw new Error('Unauthorized');
  }

  const payload = await getPayloadClient();

  await payload.delete({
    collection: 'courses',
    id,
  });

  revalidatePath('/dashboard/courses');
  redirect('/dashboard/courses');
}
```

### Validation Schema

```typescript
// src/lib/validations/course.ts
import { z } from 'zod';

export const courseSchema = z.object({
  title: z.string().min(3).max(200),
  slug: z.string().regex(/^[a-z0-9-]+$/).optional(),
  description: z.any().optional(), // Rich text
  shortDescription: z.string().max(300).optional(),
  thumbnail: z.string().optional(),
  price: z.object({
    amount: z.number().min(0),
    currency: z.enum(['USD', 'EUR', 'GBP']),
  }).optional(),
  settings: z.object({
    allowPreview: z.boolean().optional(),
    requireSequentialProgress: z.boolean().optional(),
    certificateEnabled: z.boolean().optional(),
  }).optional(),
});

export type CourseInput = z.infer<typeof courseSchema>;
```

---

## UI Components

### Course Card

```typescript
// src/components/course/CourseCard.tsx
import Image from 'next/image';
import Link from 'next/link';
import { cn } from '@/lib/utils';
import type { Course } from '@/payload-types';

interface CourseCardProps {
  course: Course;
  variant?: 'default' | 'compact';
  className?: string;
}

export function CourseCard({ course, variant = 'default', className }: CourseCardProps) {
  const price = course.price?.amount
    ? new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: course.price.currency,
      }).format(course.price.amount / 100)
    : 'Free';

  return (
    <Link
      href={`/courses/${course.slug}`}
      className={cn(
        'group block overflow-hidden rounded-lg border bg-card transition-shadow hover:shadow-lg',
        className
      )}
    >
      <div className="aspect-video relative overflow-hidden">
        {course.thumbnail ? (
          <Image
            src={typeof course.thumbnail === 'string' ? course.thumbnail : course.thumbnail.url}
            alt={course.title}
            fill
            className="object-cover transition-transform group-hover:scale-105"
          />
        ) : (
          <div className="flex h-full items-center justify-center bg-muted">
            <span className="text-muted-foreground">No image</span>
          </div>
        )}
      </div>
      <div className="p-4">
        <h3 className="font-semibold line-clamp-2">{course.title}</h3>
        {variant === 'default' && course.shortDescription && (
          <p className="mt-1 text-sm text-muted-foreground line-clamp-2">
            {course.shortDescription}
          </p>
        )}
        <div className="mt-3 flex items-center justify-between">
          <span className="font-bold text-primary">{price}</span>
          {course.modules && (
            <span className="text-sm text-muted-foreground">
              {course.modules.length} modules
            </span>
          )}
        </div>
      </div>
    </Link>
  );
}
```

### Course List Page

```typescript
// src/app/(dashboard)/dashboard/courses/page.tsx
import { Suspense } from 'react';
import Link from 'next/link';
import { Plus } from 'lucide-react';
import { getPayloadClient } from '@/lib/payload';
import { auth } from '@/lib/auth';
import { Button } from '@/components/ui/button';
import { CourseCard } from '@/components/course/CourseCard';

export default async function CoursesPage() {
  const session = await auth();
  const payload = await getPayloadClient();

  const { docs: courses } = await payload.find({
    collection: 'courses',
    where: {
      instructor: { equals: session?.user?.id },
    },
    sort: '-updatedAt',
  });

  return (
    <div className="container py-8">
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-3xl font-bold">My Courses</h1>
          <p className="text-muted-foreground">
            Manage your courses and track student progress
          </p>
        </div>
        <Button asChild>
          <Link href="/dashboard/courses/new">
            <Plus className="mr-2 h-4 w-4" />
            Create Course
          </Link>
        </Button>
      </div>

      {courses.length === 0 ? (
        <div className="text-center py-12">
          <h3 className="text-lg font-semibold">No courses yet</h3>
          <p className="text-muted-foreground mb-4">
            Create your first course to get started
          </p>
          <Button asChild>
            <Link href="/dashboard/courses/new">Create Course</Link>
          </Button>
        </div>
      ) : (
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {courses.map((course) => (
            <CourseCard key={course.id} course={course} />
          ))}
        </div>
      )}
    </div>
  );
}
```

---

## Acceptance Criteria

### Functional

- [ ] Courses can be created with title and description
- [ ] Courses have auto-generated slugs
- [ ] Course status can be changed (draft → published → archived)
- [ ] Only instructors and admins can create courses
- [ ] Only course owners or admins can edit courses
- [ ] Published courses are visible to all users
- [ ] Draft courses are only visible to owners
- [ ] Course list supports pagination
- [ ] Course thumbnails can be uploaded

### Non-Functional

- [ ] Course list loads in < 500ms
- [ ] Slug uniqueness enforced at database level
- [ ] Input validation prevents XSS
- [ ] API rate limited to prevent abuse

---

## Test Cases

```typescript
// tests/collections/courses.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { getPayloadClient } from '@/lib/payload';

describe('Courses Collection', () => {
  let payload;

  beforeEach(async () => {
    payload = await getPayloadClient();
  });

  it('creates a course with valid data', async () => {
    const course = await payload.create({
      collection: 'courses',
      data: {
        title: 'Test Course',
        instructor: 'user-id',
        status: 'draft',
      },
    });

    expect(course.title).toBe('Test Course');
    expect(course.slug).toBe('test-course');
    expect(course.status).toBe('draft');
  });

  it('auto-generates slug from title', async () => {
    const course = await payload.create({
      collection: 'courses',
      data: {
        title: 'My Amazing Course!',
        instructor: 'user-id',
      },
    });

    expect(course.slug).toBe('my-amazing-course');
  });

  it('enforces unique slugs', async () => {
    await payload.create({
      collection: 'courses',
      data: { title: 'Test', slug: 'test', instructor: 'user-id' },
    });

    await expect(
      payload.create({
        collection: 'courses',
        data: { title: 'Test 2', slug: 'test', instructor: 'user-id' },
      })
    ).rejects.toThrow();
  });

  it('validates title length', async () => {
    await expect(
      payload.create({
        collection: 'courses',
        data: { title: 'ab', instructor: 'user-id' },
      })
    ).rejects.toThrow();
  });
});
```

---

**Document Version:** 1.0.0
**Last Updated:** January 2026
