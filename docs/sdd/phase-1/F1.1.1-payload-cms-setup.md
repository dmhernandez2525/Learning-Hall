# F1.1.1: Payload CMS + Next.js Setup

**Version:** 1.0.0
**Priority:** P0 (Critical)
**Effort:** Medium (3-5 days)
**Dependencies:** None

---

## Overview

Initialize the Learning Hall project with Next.js 14 (App Router) and Payload CMS v3 embedded in the same application. This establishes the foundation for all subsequent features.

---

## Objectives

1. Create Next.js 14 project with App Router
2. Integrate Payload CMS v3 as embedded CMS
3. Configure PostgreSQL database connection
4. Set up project structure following DDD patterns
5. Configure TypeScript strict mode
6. Set up Tailwind CSS 4.x with shadcn/ui
7. Configure Vitest for testing
8. Create initial CI/CD pipeline

---

## Technical Specification

### Project Structure

```
Learning-Hall/
├── src/
│   ├── app/                          # Next.js App Router
│   │   ├── (auth)/                   # Auth route group
│   │   │   ├── login/page.tsx
│   │   │   ├── register/page.tsx
│   │   │   └── layout.tsx
│   │   ├── (dashboard)/              # Dashboard route group
│   │   │   ├── dashboard/page.tsx
│   │   │   ├── courses/
│   │   │   └── layout.tsx
│   │   ├── (marketing)/              # Public pages
│   │   │   ├── page.tsx              # Homepage
│   │   │   ├── pricing/page.tsx
│   │   │   ├── features/page.tsx
│   │   │   └── layout.tsx
│   │   ├── (admin)/                  # Payload Admin
│   │   │   └── admin/[[...segments]]/page.tsx
│   │   ├── api/                      # API routes
│   │   │   ├── [...payload]/route.ts # Payload REST API
│   │   │   └── graphql/route.ts      # Payload GraphQL
│   │   ├── layout.tsx                # Root layout
│   │   └── globals.css               # Global styles
│   ├── collections/                  # Payload collections
│   │   ├── Users.ts
│   │   ├── Tenants.ts
│   │   ├── Courses.ts
│   │   ├── Modules.ts
│   │   ├── Lessons.ts
│   │   └── index.ts
│   ├── components/                   # React components
│   │   ├── ui/                       # shadcn/ui components
│   │   ├── forms/
│   │   ├── layout/
│   │   └── index.ts
│   ├── lib/                          # Utilities
│   │   ├── utils.ts                  # cn() helper
│   │   ├── payload.ts                # Payload client
│   │   └── validations/
│   ├── hooks/                        # Custom hooks
│   ├── types/                        # TypeScript types
│   └── payload.config.ts             # Payload configuration
├── public/
├── docs/
├── tests/
│   ├── setup.ts
│   └── utils.tsx
├── .env.example
├── .env.local
├── .gitignore
├── docker-compose.yml
├── Dockerfile
├── next.config.mjs
├── package.json
├── tailwind.config.ts
├── tsconfig.json
└── vitest.config.ts
```

### Payload Configuration

```typescript
// src/payload.config.ts
import { buildConfig } from 'payload';
import { postgresAdapter } from '@payloadcms/db-postgres';
import { lexicalEditor } from '@payloadcms/richtext-lexical';
import { vercelBlobStorage } from '@payloadcms/storage-vercel-blob';
import path from 'path';

import { Users } from './collections/Users';
import { Tenants } from './collections/Tenants';
import { Courses } from './collections/Courses';
import { Modules } from './collections/Modules';
import { Lessons } from './collections/Lessons';

export default buildConfig({
  admin: {
    user: Users.slug,
    meta: {
      titleSuffix: '- Learning Hall',
      favicon: '/favicon.ico',
      ogImage: '/og-image.png',
    },
  },
  collections: [Users, Tenants, Courses, Modules, Lessons],
  db: postgresAdapter({
    pool: {
      connectionString: process.env.DATABASE_URL,
    },
  }),
  editor: lexicalEditor(),
  secret: process.env.PAYLOAD_SECRET || '',
  typescript: {
    outputFile: path.resolve(__dirname, 'payload-types.ts'),
  },
  graphQL: {
    schemaOutputFile: path.resolve(__dirname, 'generated-schema.graphql'),
  },
});
```

### Next.js Configuration

```typescript
// next.config.mjs
import { withPayload } from '@payloadcms/next/withPayload';

/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    reactCompiler: false,
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**.r2.cloudflarestorage.com',
      },
      {
        protocol: 'https',
        hostname: '**.s3.amazonaws.com',
      },
    ],
  },
};

export default withPayload(nextConfig);
```

### TypeScript Configuration

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["dom", "dom.iterable", "ES2022"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [{ "name": "next" }],
    "paths": {
      "@/*": ["./src/*"],
      "@/payload-types": ["./src/payload-types.ts"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

### Tailwind Configuration

```typescript
// tailwind.config.ts
import type { Config } from 'tailwindcss';

const config: Config = {
  darkMode: ['class'],
  content: [
    './src/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#f0fdfa',
          100: '#ccfbf1',
          200: '#99f6e4',
          300: '#5eead4',
          400: '#2dd4bf',
          500: '#14b8a6',
          600: '#0d9488',
          700: '#0f766e',
          800: '#115e59',
          900: '#134e4a',
          950: '#042f2e',
        },
        secondary: {
          50: '#eef2ff',
          100: '#e0e7ff',
          200: '#c7d2fe',
          300: '#a5b4fc',
          400: '#818cf8',
          500: '#6366f1',
          600: '#4f46e5',
          700: '#4338ca',
          800: '#3730a3',
          900: '#312e81',
          950: '#1e1b4b',
        },
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif'],
        mono: ['JetBrains Mono', 'monospace'],
      },
    },
  },
  plugins: [require('tailwindcss-animate')],
};

export default config;
```

---

## Implementation Steps

### Step 1: Initialize Project

```bash
# Create Next.js project
npx create-next-app@latest Learning-Hall --typescript --tailwind --eslint --app --src-dir

# Navigate to project
cd Learning-Hall

# Install Payload CMS
npm install payload @payloadcms/next @payloadcms/db-postgres @payloadcms/richtext-lexical

# Install additional dependencies
npm install next-auth@beta zod react-hook-form @hookform/resolvers
npm install class-variance-authority clsx tailwind-merge lucide-react
npm install -D vitest @testing-library/react @vitejs/plugin-react happy-dom
```

### Step 2: Configure Payload

1. Create `src/payload.config.ts`
2. Create collections in `src/collections/`
3. Set up Payload API routes
4. Configure admin panel

### Step 3: Set Up Database

```bash
# Start PostgreSQL
docker-compose up -d db

# Generate Payload types
npm run payload generate:types

# Run migrations
npm run payload migrate
```

### Step 4: Configure Testing

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'happy-dom',
    globals: true,
    setupFiles: ['./tests/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      thresholds: {
        branches: 80,
        functions: 80,
        lines: 80,
        statements: 80,
      },
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

---

## Acceptance Criteria

### Functional

- [ ] Next.js 14 application starts successfully
- [ ] Payload admin panel accessible at `/admin`
- [ ] PostgreSQL database connection works
- [ ] Basic collections (Users, Tenants) created
- [ ] TypeScript types auto-generated from Payload schema
- [ ] Tailwind CSS styling works
- [ ] shadcn/ui components installable

### Non-Functional

- [ ] Build completes without errors
- [ ] TypeScript strict mode enabled with no errors
- [ ] ESLint passes with no errors
- [ ] Initial test suite runs
- [ ] Development server hot reload works
- [ ] Production build size reasonable (<500KB initial JS)

---

## Testing Requirements

### Unit Tests

```typescript
// tests/setup.ts
import { expect, afterEach } from 'vitest';
import { cleanup } from '@testing-library/react';
import * as matchers from '@testing-library/jest-dom/matchers';

expect.extend(matchers);

afterEach(() => {
  cleanup();
});
```

### Test Cases

1. **Payload Configuration**
   - Config loads without errors
   - Collections are properly defined
   - Database adapter connects

2. **Next.js Routes**
   - Homepage renders
   - Admin route redirects unauthenticated users
   - API routes respond

3. **Components**
   - UI components render correctly
   - Theme switching works

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/payload.config.ts` | Create | Payload CMS configuration |
| `src/collections/*.ts` | Create | All collection definitions |
| `src/app/layout.tsx` | Modify | Add providers, metadata |
| `src/app/(admin)/admin/[[...segments]]/page.tsx` | Create | Payload admin route |
| `src/app/api/[...payload]/route.ts` | Create | Payload REST API |
| `src/lib/utils.ts` | Create | Utility functions |
| `next.config.mjs` | Modify | Add Payload plugin |
| `tailwind.config.ts` | Modify | Add custom theme |
| `vitest.config.ts` | Create | Test configuration |
| `docker-compose.yml` | Create | Local development |
| `.env.example` | Create | Environment template |

---

## Rollback Plan

If issues arise:

1. Revert to previous commit
2. Check PostgreSQL connection string
3. Verify Payload secret is set
4. Clear `.next` cache and rebuild

---

**Document Version:** 1.0.0
**Last Updated:** January 2026
**Author:** Learning Hall Team
